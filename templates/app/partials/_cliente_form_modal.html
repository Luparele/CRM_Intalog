{% load django_bootstrap5 %}

<form hx-post="{% url 'app:salvar-cliente-prospeccao' %}" 
      hx-target="#main-modal-content" 
      hx-swap="innerHTML"
      hx-on::after-request="if(event.detail.successful && event.detail.xhr.status === 204) location.reload()">
    
    {% csrf_token %}
    
    <div class="modal-header">
        <h5 class="modal-title">Novo Cliente Prospect</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    
    <div class="modal-body">
        <div class="mb-3">
            <label for="id_cnpj" class="form-label">CNPJ</label>
            <div class="input-group">
                {{ form.cnpj }}
                <button class="btn btn-outline-secondary" type="button" id="btn-consultar-cnpj-prospect" title="Consultar dados na Receita">
                    <i class="bi bi-search"></i> Buscar
                </button>
            </div>
            {% if form.cnpj.errors %}
                <div class="text-danger small">{{ form.cnpj.errors.0 }}</div>
            {% endif %}
        </div>

        {% bootstrap_field form.razao_social %}
        {% bootstrap_field form.nome_contato %}
        {% bootstrap_field form.telefone_contato %}
        {% bootstrap_field form.email_contato %}
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success">Cadastrar Prospect</button>
    </div>
</form>

<script>
    (function() {
        const btnConsulta = document.getElementById('btn-consultar-cnpj-prospect');
        if (btnConsulta) {
            btnConsulta.addEventListener('click', function() {
                const cnpjInput = document.getElementById('id_cnpj');
                const razaoSocialInput = document.getElementById('id_razao_social');
                
                const cnpj = cnpjInput.value.replace(/[^\d]/g, '');

                if (cnpj.length === 14) {
                    const url = `/api/consulta-cnpj/${cnpj}/`;
                    
                    // Feedback visual
                    const originalContent = this.innerHTML;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                    this.disabled = true;
                    const btn = this;

                    fetch(url)
                        .then(response => {
                            if (!response.ok) throw new Error('CNPJ nao encontrado.');
                            return response.json();
                        })
                        .then(data => {
                            if (data.error) {
                                alert(data.error);
                            } else {
                                razaoSocialInput.value = data.razao_social;
                                razaoSocialInput.focus();
                            }
                        })
                        .catch(error => {
                            alert('Erro: ' + error.message);
                        })
                        .finally(() => {
                            btn.innerHTML = originalContent;
                            btn.disabled = false;
                        });
                } else {
                    alert('CNPJ invalido para consulta. Digite 14 digitos.');
                }
            });
        }
    })();
</script>